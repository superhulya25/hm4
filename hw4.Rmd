---
title: "Template for hw4"
output: html_notebook
---

Це ноутбук з даними "за замовчуванням" для домашнього завдання з аналізу таблиць. Якщо ви працюєте з даними в межах підсумкового проєкту, можна виконати на цих даних тільки ті операції, які не вдається зробити з вашими даними. Або використати ноутбук як шаблон.

*На початку кожного кроку можна прочитати дані, отримані в результаті попередніх кроків. Це щоб орієнтуватись або викнати лише ті операції, яких не було у роботі з датасетом для проєкту.*

```{r}
library(tidyverse)
library(lubridate)
library(rvest)
```

## Підготовка
Дані "за замовчуванням"
1) дані авіаційного трафіку за країнами, подивіться `?html_table`
```{r}
air <- read_html("https://www.radarbox.com/statistics/total") %>%
  html_node("table#datatable") %>%
  html_table() %>%
  rename(date = Day)

# Трохи приведемо до ладу назви колонок, для зручності
colnames(air) <- colnames(air) %>%
  str_replace("  ", "_") %>%
  str_replace(" ", ".") %>%
  str_to_lower()
```

## Завдання


```{r}
date
```

### 2. Виберіть лише потрібні колонки

```{r}
df <- air %>%
 select(iran_non.iran, date)  # лапки дають помилку, тож без них
df
```


```{r}
date
```



### 3. Сортування

```{r}
# df <- read.csv("checkpoints/df-2.csv")
?arrange  # як працює сортування в tidy. Розумію вас, сама часто пишу "sort" замість "arrange"

df <- df %>% arrange(date)
df
```

### 4. Розрахунок нових змінних
Фідбек: тут все супер
```{r}
#df <- read.csv("checkpoints/df-3.csv")

df <- mutate(df,
       year = year(date),
       month = month(date),
       day = day(date))
df


```

### 5. Фільтрування з групуванням

```{r}
df %>% mutate(n())
```

```{r}
df <- df %>%    # не забувайте присвоювати значення, бо результат роботи не буде зберігатись 
  group_by(day, month) %>%
  filter(n() == 2) %>%    # бо ми хочемо фільтрувати, а не рахувати нову колонку
  ungroup()    # розгрупуємо, коли діло зроблено. Інакше потім df буде згрупований і можуть бути помилки через це
  
```

```{r}
df %>% filter(day == 10, month == 10)
```

```{r}
df %>% filter(day == 1, month == 4)
```



### 6. Перетворення

```{r}
# df <- read.csv("checkpoints/df-5.csv")

wider_df <- df %>% 
  pivot_wider(id_cols = c("day", "month"),
              names_from = "year",
              values_from = "iran_non.iran",
              names_prefix = "y")

wider_df
```


```{r}
# wider_df <- read.csv("checkpoints/df-5-wider.csv")

#?str_c

wider_df <- wider_df %>%
  mutate(date = str_c(2020, month, day, sep = "-"),
         date = as.Date(date),
         change_percent = y2020 / y2019)  # тут же можна порахувати, на скільки % змінились польоти з/до Ірану у 2020-му році порівняно з 2019
# "day" це просто рядок, у якому написано "day", а day без лапок — то ваша змінна  
 
wider_df

```

### 7. З'єднання


```{r}
prepare_covid <- function(url, col_name) {
  d <- read.csv(url) %>%
    rename(region = Province.State, country = Country.Region) %>%
    pivot_longer(cols = -c(region, country, Lat, Long),
                 names_to = "date",
                 names_prefix = "X",
                 values_to = col_name
                 ) %>%
    mutate(date = mdy(date)) %>%
    select(-c(Lat, Long)) %>%
    group_by(country, date) %>%
    summarise(col_name = sum(get(col_name)))
  
  cnames <- colnames(d)
  cnames[cnames == "col_name"] <- col_name
  colnames(d) <- cnames
  return(d)
}

covid19 <- prepare_covid("https://bit.ly/3aLLfKw", "cases") %>%
  full_join(prepare_covid("https://bit.ly/2XdZ6W0", "recovered")) %>%
  full_join(prepare_covid("https://bit.ly/2yEhPQg", "deaths")) %>%
  mutate(active_cases = cases - recovered - deaths,
         date = as.Date(date))

covid19
```


```{r}
# wider_df <- read.csv("checkpoints/df-6-wider.csv") %>%
#   mutate(date = as.Date(date))

# filter — щоб вибрати рядки за значенням змінних, select — щоб вибрати колонки за іменем
covid19 <- covid19 %>%
 filter(country == "Iran")

# join(df, air, by = null, type = left, match = all)
# краще вказувати, який саме джойн, і датафрейми переплутали

df_final <- covid19 %>%
  left_join(wider_df, by = c("date"))
```

Бонусний графік
```{r}
df_for_plot <- df_final %>%
  ungroup() %>%  # чогось воно було згруповане, можу я помилилась раніше і не розгрупувала
  select(date,
         "Кількість активних випадків" = active_cases,  # тут же перейменуємо колонки для графіка
         "Частка зовнішніх рейсів у порівнянні з 2019 р." = change_percent) %>%
  pivot_longer(cols = -c(date), names_to = "what", values_to = "n")


ggplot(df_for_plot, aes(date, n, color = what)) +
  geom_line(show.legend = FALSE) + 
  facet_wrap(vars(what), scales = "free_y") +
  labs(title = "Іран. Коронавірус та авіація") + 
  theme_minimal()

# якщо ще подописувати стиль теми, буде цілком гарний графік
```


### 8. Збережіть отримані з'єднані дані в csv.
```{r}



x <- mtcars$wt
y <- mtcars$mpg


plot(x, y, main = "Covid19"
     xlab = "x axis title", ylab = "Y axis title",
     pch = 19, frame = FALSE)
```


### Що вийшло в результаті 
```{r}
read.csv("checkpoints/final_result.csv")
```

